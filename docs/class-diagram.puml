@startuml Revellio Architecture

package "UI Layer" {
  class FileDrop {
    +onFilesSelected(files: File[])
  }
  
  class DataMeshVisualization {
    +dataMeshOutput: DataMeshOutput
    +csvData: CSVData[]
    +onUpdateRelations(relations: DataMeshRelation[])
    +render()
    +handleRelationEdit()
  }
  
  class Visualizer {
    +aiOutput: UnifiedAIOutput
    +csvData: CSVData[]
    +render()
  }
  
  class DynamicVisualization {
    +instruction: VisualizationInstruction
    +csvData: CSVData[]
    +render()
  }
}

package "Data Processing Layer" {
  class CSVParser {
    +parse(file: File): CSVData
    +validate(data: string): boolean
  }
  
  class MetadataExtractor {
    +extractAll(csvData: CSVData[]): Metadata[]
  }
}

package "AI Layer" {
  class AIService {
    +dataMesh(metadata: Metadata[], dataSlices: CSVData[], userPrompt: string): DataMeshOutput
    +unifiedAnalysis(metadata: Metadata[], dataSlices: CSVData[], userPrompt: string, relations: DataMeshRelation[]): UnifiedAIOutput
    -buildDataMeshPrompt()
    -buildUnifiedAnalysisPrompt()
  }
}

package "API Layer" {
  class DataMeshRoute {
    +POST(request: NextRequest): NextResponse<DataMeshOutput>
    -validateRequest()
  }
  
  class AnalyzeRoute {
    +POST(request: NextRequest): NextResponse<UnifiedAIOutput>
    -validateRequest()
  }
}

package "Types" {
  class CSVData {
    +fileName: string
    +columns: string[]
    +rows: Row[]
    +metadata: Metadata
    +rawContent: string
  }
  
  class Metadata {
    +fileName: string
    +columns: Column[]
    +columnTypes: ColumnType[]
    +sample: SampleData
    +rowCount: number
    +hasHeader: boolean
  }
  
  class DataMeshRelation {
    +element1: string
    +element1Source: ElementSource
    +element2: string
    +element2Source: ElementSource
    +relationExplanation: string
  }
  
  class DataMeshOutput {
    +relations: DataMeshRelation[]
    +summary: string
  }
  
  class VisualizationInstruction {
    +type: VisualizationType
    +module: string
    +config: VisualizationConfig
    +reasoning: string
  }
  
  class UnifiedAIOutput {
    +visualizations: VisualizationInstruction[]
    +relations: Relation[]
    +reasoning: string
    +metadata: OutputMetadata
  }
}

' Relationships
FileDrop --> CSVParser : uses
CSVParser --> CSVData : creates
MetadataExtractor --> CSVData : extracts from
MetadataExtractor --> Metadata : creates

DataMeshRoute --> AIService : calls
DataMeshRoute --> DataMeshOutput : returns
AnalyzeRoute --> AIService : calls
AnalyzeRoute --> UnifiedAIOutput : returns

AIService --> Metadata : uses
AIService --> CSVData : uses
AIService --> DataMeshOutput : creates
AIService --> UnifiedAIOutput : creates
AIService --> DataMeshRelation : uses

DataMeshVisualization --> DataMeshOutput : displays
DataMeshVisualization --> DataMeshRelation : edits
DataMeshVisualization --> CSVData : uses

Visualizer --> UnifiedAIOutput : displays
Visualizer --> DynamicVisualization : uses
Visualizer --> CSVData : uses

DynamicVisualization --> VisualizationInstruction : uses
DynamicVisualization --> CSVData : uses

note right of AIService
  Two-step AI process:
  1. dataMesh() - Detects relations
  2. unifiedAnalysis() - Creates visualizations
  based on edited relations
end note

note right of DataMeshVisualization
  User can:
  - View all relations
  - Edit explanations
  - Remove relations
  - Modify connections
end note

@enduml

